<!doctype html>
<html class="w-full antialiased" lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bonfire</title>
    <meta name="description" content="A federated social network for individuals and communities to design, operate and control their own digital lives.">
    <link rel="icon" type="image/x-icon" href="/img/favicon.ico">
    <link
    rel="stylesheet" href="/css/style_v2.css">
    <script async defer src="https://buttons.github.io/buttons.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/intersect@3.x.x/dist/cdn.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/focus@3.x.x/dist/cdn.min.js"></script>
    <script nomodule src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="Bonfire">
    <script src="//unpkg.com/alpinejs" defer></script>
    <link href="https://unpkg.com/prismjs@1.20.0/themes/prism-okaidia.css" rel="stylesheet">
  </head>
  <body data-theme="bonfire" class="body-theme w-full bg-base-100 antialiased">
    <div
      class="sticky top-0 z-[999999999999999999] transition duration-500 ease-in-out"
      x-data="{open: false, atTop: false}" 
       :class="{ 'shadow-lg': atTop, 'bg-transparent text-base-content': !atTop, 'bg-base-100 text-base-content': atTop }"
      @scroll.window="atTop = (window.pageYOffset < 50) ? false: true"
    >
    

    <div class="bg-base-300">
      <header class="relative z-30 lg:px-8 mx-auto navbar">
        <div class="navbar-start w-[70%]">
          <div class="flex  items-center flex-shrink-0">
            <a href="/" class="flex items-center space-x-4">
              <span class="block bg-center bg-no-repeat bg-cover" style="width: 30px; height: 40px; background-image: url(/img/bonfire.png)"></span>  
              <span class="flex items-center"><span class="text-base font-bold tracking-wider text-base-content">Bonfire</span> 
              
              </span>
            </a>
          </div>
           <div class="ml-4 hidden xl:flex">
          <ul class="flex-row  p-0 font-medium menu menu-compact menu-horizontal">
            <li class="dropdown">
              
              <a href="/about" role="button" tabindex="0" class="flex items-center gap-2">
                <span>About</span>
                
              </a>
              
              
            </li>
            <li class="dropdown">
                <div tabindex="0" class="flex items-center gap-2">
                  <span>Ecosystem</span>
                  <svg class="fill-current" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"><path d="M7.41,8.58L12,13.17L16.59,8.58L18,10L12,16L6,10L7.41,8.58Z"/></svg>
                </div>
              
              <ul tabindex="0" class="dropdown-content min-w-[280px] border border-base-content/30 !ml-0 menu mt-2 p-1 bg-base-300 rounded-lg">
                <li>
                  <a href="/apps" class="flex flex-col rounded-lg flex-wrap items-start">
                      <div class="font-bold">Apps</div>
                      <div class="font-light -mt-1.5  text-sm text-base-content/70 font-light">Apps built with Bonfire</div>
                  </a>
                </li>
                <li>
                  <a href="/extensions" class="flex flex-col rounded-lg flex-wrap items-start" >
                      <div class="font-bold">Extensions</div>
                      <div class="font-light -mt-1.5  text-sm text-base-content/70 font-light">Explore available extensions</div>
                  </a>
                </li>
                <li>
                  <a class="flex flex-col rounded-lg flex-wrap items-start" href="/themes">
                      <div class="font-bold">Themes</div>
                      <div class="font-light -mt-1.5  text-sm text-base-content/70 font-light">Personalize Bonfire with your preferred colors and styling</div>
                  </a>
                </li>
                  <li>
                  <a class="flex flex-col rounded-lg flex-wrap items-start" href="/pilots">
                      <div class="font-bold">Pilots</div>
                      <div class="font-light -mt-1.5  text-sm text-base-content/70 font-light">Some of the communities we are working with</div>
                  </a>
                </li>
                <li>
                  <a class="flex flex-col rounded-lg flex-wrap items-start" href="/community">
                      <div class="font-bold">How to participate</div>
                      <div class="font-light -mt-1.5  text-sm text-base-content/70 font-light">Contribute to Bonfire</div>
                  </a>
                </li>
              </ul>
            </li>
            <li class="dropdown">
                <div tabindex="0" class="flex items-center gap-2">
                  <span>Learn</span>
                  <svg class="fill-current" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"><path d="M7.41,8.58L12,13.17L16.59,8.58L18,10L12,16L6,10L7.41,8.58Z"/></svg>
                </div>
              <ul tabindex="0" class="dropdown-content min-w-[280px] border border-base-content/30 !ml-0 menu mt-2 p-1 bg-base-300 rounded-lg ">
                <li>
                  <a class="flex flex-col rounded-lg flex-wrap items-start" href="https://doc.bonfirenetworks.org">
                      <div class="font-bold">Documentation</div>
                      <div class="font-light text-sm text-base-content/70 -mt-1.5">Dive into using or building on Bonfire</div>
                  </a>
                </li>
                 <li>
                  <a class="flex flex-col rounded-lg flex-wrap items-start" href="/design">
                      <div class="font-bold">Design</div>
                      <div class="font-light text-sm text-base-content/70 -mt-1.5">Think with Bonfire to create better digital spaces</div>
                  </a>
                </li>
                <li>
                  <a class="flex rounded-lg flex-col flex-wrap items-start" href="/community">
                      <div class="font-bold">Community</div>
                      <div class="font-light text-sm text-base-content/70 -mt-1.5">How to participate in the ecosystem</div>
                  </a>
                </li>
                <li>
                  <a class="flex rounded-lg flex-col flex-wrap items-start" href="/faq">
                    <div class="font-bold">FAQ</div>
                    <div class="text-sm -mt-1.5 font-light text-base-content/70">Frequently asked questions</div>
                  </a>
                </li>
                
                <li>
                  <a class="flex flex-col rounded-lg flex-wrap items-start" href="/docs/changelog">
                    <div class="font-bold">Changelog</div>
                    <div class="font-light text-sm text-base-content/70 -mt-1.5">Latest updates and improvements</div>
                  </a></li>
                <li>
                  <a class="flex flex-col rounded-lg flex-wrap items-start" href="https://github.com/bonfire-networks/bonfire-app" target="_blank">
                    <div class="font-bold">Get the code</div>
                    <div class="font-light text-sm text-base-content/70 -mt-1.5">Bonfire is open source and AGPL3 licensed</div>
                  </a>
                </li>
              </ul>
            </li>
            
            <li>
            <a href="/hosting" class=" ">
              <span class="text-sm font-regular">Hosting</span>
            </a>
            </li>
            
       

            

            <li>
            <a href="/blog" class=" ">
              <span class="text-sm font-regular">News</span>
            </a>
            </li>
          </ul>
        </div>
        



        </div>
        
        <div class="navbar-end">
           <label for="theme_controller" class="swap swap-rotate mr-4">
  
              <!-- this hidden checkbox controls the state -->
              <input id="theme_controller" type="checkbox" class="theme-controller" value="bonfire" />
              
              <!-- sun icon -->
              <svg class="swap-on fill-current w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5.64,17l-.71.71a1,1,0,0,0,0,1.41,1,1,0,0,0,1.41,0l.71-.71A1,1,0,0,0,5.64,17ZM5,12a1,1,0,0,0-1-1H3a1,1,0,0,0,0,2H4A1,1,0,0,0,5,12Zm7-7a1,1,0,0,0,1-1V3a1,1,0,0,0-2,0V4A1,1,0,0,0,12,5ZM5.64,7.05a1,1,0,0,0,.7.29,1,1,0,0,0,.71-.29,1,1,0,0,0,0-1.41l-.71-.71A1,1,0,0,0,4.93,6.34Zm12,.29a1,1,0,0,0,.7-.29l.71-.71a1,1,0,1,0-1.41-1.41L17,5.64a1,1,0,0,0,0,1.41A1,1,0,0,0,17.66,7.34ZM21,11H20a1,1,0,0,0,0,2h1a1,1,0,0,0,0-2Zm-9,8a1,1,0,0,0-1,1v1a1,1,0,0,0,2,0V20A1,1,0,0,0,12,19ZM18.36,17A1,1,0,0,0,17,18.36l.71.71a1,1,0,0,0,1.41,0,1,1,0,0,0,0-1.41ZM12,6.5A5.5,5.5,0,1,0,17.5,12,5.51,5.51,0,0,0,12,6.5Zm0,9A3.5,3.5,0,1,1,15.5,12,3.5,3.5,0,0,1,12,15.5Z"/></svg>
              
              <!-- moon icon -->
              <svg class="swap-off fill-current w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21.64,13a1,1,0,0,0-1.05-.14,8.05,8.05,0,0,1-3.37.73A8.15,8.15,0,0,1,9.08,5.49a8.59,8.59,0,0,1,.25-2A1,1,0,0,0,8,2.36,10.14,10.14,0,1,0,22,14.05,1,1,0,0,0,21.64,13Zm-9.5,6.69A8.14,8.14,0,0,1,7.08,5.22v.27A10.15,10.15,0,0,0,17.22,15.63a9.79,9.79,0,0,0,2.1-.22A8.11,8.11,0,0,1,12.14,19.73Z"/></svg>
              
            </label>
          <a href="/start/" >
            <span class="hidden  normal-case rounded-full btn btn-sm btn-primary xl:flex">Get Bonfire</span>
          </a>

          <div class="inset-y-0 right-0 flex gap-3 items-center xl:hidden">
            <a href="/start/" >
              <span class="normal-case rounded-full btn btn-sm btn-primary">Get started</span>
            </a>
              <span class="sr-only">Open main menu</span>
              <label class="btn btn-circle btn-ghost swap swap-rotate">
  
              <!-- this hidden checkbox controls the state -->
              <input type="checkbox" />
              
              <!-- hamburger icon -->
              <svg @click="open = !open" class="swap-off fill-current" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 512 512"><path d="M64,384H448V341.33H64Zm0-106.67H448V234.67H64ZM64,128v42.67H448V128Z"/></svg>
              
              <!-- close icon -->
              <svg @click="open = !open" class="swap-on fill-current" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 512 512"><polygon points="400 145.49 366.51 112 256 222.51 145.49 112 112 145.49 222.51 256 112 366.51 145.49 400 256 289.49 366.51 400 400 366.51 289.49 256 400 145.49"/></svg>
              
            </label>
          </div>

        </div>
      

    
      </header>
    </div>
    <div 
      x-description="Mobile menu, show/hide based on menu state." 
      class="xl:hidden" 
      id="mobile-menu" 
      x-show="open" 
      style="display: none;">
      <ul class="p-0 menu bg-base-300">
          <li>
            <a href="/about" class=" ">
            <span class="text-base font-regular">About</span>
          </a>
          </li>

            <li>
            <a href="/apps" class=" ">
            <span class="text-base font-regular">Apps</span>
          </a>
          </li>

          <li>
            <a href="/extensions" class=" ">
            <span class="text-base font-regular">Extensions</span>
          </a>
          </li>

          <li>
            <a href="/themes" class=" ">
            <span class="text-base font-regular">Themes</span>
          </a>
          </li>


            <li>
            <a href="/docs" class=" ">
            <span class="text-base font-regular">Documentation</span>
          </a>
          </li>

          <li>
            <a href="/courses" class=" ">
            <span class="text-base font-regular">courses</span>
          </a>
          </li>
          
          
          <li>
            <a href="/pilots" class=" ">
            <span class="text-base font-regular">Pilots</span>
          </a>
          </li>
          
          <li>
            <a href="/faq" class=" ">
            <span class="text-base font-regular">FAQs</span>
          </a>
          </li>
          <li>
          <a href="/blog" class=" ">
            <span class="text-base font-regular">News</span>
          </a>
          </li>
          <li>
            <a href="/community" class=" ">
              <span class="text-base font-regular">Community</span>
            </a>
          </li>

          <li>
            <a href="https://github.com/bonfire-networks/bonfire-app" class=" ">
              <span class="text-base font-regular">Get the code</span>
            </a>
          </li>
          
      </ul>
    </div>
  </div>

 <script>
    document.addEventListener('DOMContentLoaded', (event) => {
    const themeController = document.querySelector('.theme-controller');
    const bodyElement = document.body;

    // Load the saved theme from localStorage
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) {
        themeController.checked = savedTheme === 'bonfire';
        bodyElement.setAttribute('data-theme', savedTheme);
    }

    // Save the theme to localStorage whenever it changes
    themeController.addEventListener('change', (event) => {
        const theme = event.target.checked ? 'bonfire' : 'light';
        localStorage.setItem('theme', theme);
        bodyElement.setAttribute('data-theme', theme);
    });
});
</script>
    


<div class="bg-base-300">
  <div class="max-w-screen-lg py-12 px-4 lg:px-0  lg:mx-auto">
    <div class="text-sm breadcrumbs">
      <ul>
        <li><a href="/extensions">Extensions</a></li> 
        
      </ul>
    </div>
    <h1 class="text-3xl font-bold text-base-content  ">needle</h1>
    <p class="text-blueGray-300 w-full prose prose-md max-w-prose mt-2">One foreign key to rule them all and in the darkness, bind them.</p>
    <div class="relative inline-block mt-6">
      
    <input value="just dep-clone-local needle https://github.com/bonfire-networks/needle" class="input w-[420px] input-bordered text-sm" />
    <span class="absolute right-[8px] top-[8px] btn btn-sm btn-square">
        <svg class="w-5 h-5 text-base-content/70" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path d="M7 9.667A2.667 2.667 0 0 1 9.667 7h8.666A2.667 2.667 0 0 1 21 9.667v8.666A2.667 2.667 0 0 1 18.333 21H9.667A2.667 2.667 0 0 1 7 18.333z"/><path d="M4.012 16.737A2.005 2.005 0 0 1 3 15V5c0-1.1.9-2 2-2h10c.75 0 1.158.385 1.5 1"/></g></svg>
      </span>
    </div>
    

  </div>
</div>
<div class="my-12 max-w-screen-lg mx-auto grid grid-cols-12 gap-8 px-4 lg:px-0">

  <div class="lg:col-span-8 order-last lg:order-first col-span-12"
    <h2 class="font-semibold text-xl h-8 flex items-center">Overview</h2>

    <div class="border-base-content/30 rounded-lg border p-4 mt-8  prose max-w-full">
      <div class="uppercase tracking-widest mb-6">Readme</div>
        
        <h1 id="needles-and-pointers%3A-universal-foreign-keys%2C-virtual-schemas%2C-and-shared-data-fields-for-ecto">Needles and Pointers: Universal foreign keys, virtual schemas, and shared data fields for Ecto <a class="direct-link" href="#needles-and-pointers%3A-universal-foreign-keys%2C-virtual-schemas%2C-and-shared-data-fields-for-ecto">#</a></h1>
<blockquote>
<p>One foreign key to rule them all and in the darkness, bind them. - Gandalf, paraphrased.</p>
</blockquote>
<p><a href="https://hex.pm/packages/needle"><img src="https://img.shields.io/hexpm/v/needle" alt="hex.pm"></a><br>
<a href="https://hexdocs.pm/needle">hexdocs</a></p>
<h2 id="intro">Intro <a class="direct-link" href="#intro">#</a></h2>
<p>Bonfire uses the excellent PostgreSQL database for most data storage. PostgreSQL allows us to make a wide range of queries and to make them relatively fast while upholding data integrity guarantees.</p>
<p>Postgres is a relational schema-led database - it expects you to pre-define tables and the fields in each table (represented in tabular form, i.e. as a collection of tables with each table consisting of a set of rows and columns). Fields can contain data or a reference to a row in another table.</p>
<p>This usually means that a field containing a reference has to be pre-defined with a foreign key pointing to a specific field (typically a primary key, like an ID column) <em>in a specific table</em>.</p>
<p>A simple example would be a blogging app, which might have a <code>post</code> table with <code>author</code> field that references the <code>user</code> table.</p>
<p>A social network, by contrast, is actually a graph of objects. Objects need to be able to refer to other objects by their ID without knowing their type.</p>
<p>A simple example would be likes, you might have a <code>likes</code> table with <code>liked_post_id</code> field that references the <code>post</code> table. But you don't just have posts that can be liked, but also videos, images, polls, etc, each with their own table, but probably do not want to have to add <code>liked_video_id</code>, <code>liked_image_id</code>, etc?</p>
<p>We needed the flexibility to have a foreign key that can reference any referenceable object. We call our system <code>Needle</code>.</p>
<p>This guide is a brief introduction to Needle. It assumes some foundational knowledge:</p>
<ul>
<li>
<p>Basic understanding of how relational databases like Postgresql work, in particular:</p>
<ul>
<li>Tables being made up of fields.</li>
<li>What a primary key is and why it's useful.</li>
<li>Foreign keys and relationships between tables (1 to 1, 1 to Many, Many to 1, Many to Many).</li>
<li>Views as virtual tables backed by a SQL query.</li>
</ul>
</li>
<li>
<p>Basic understanding of Elixir (enough to follow the examples).</p>
</li>
<li>
<p>Basic working knowledge of the <a href="https://hexdocs.pm/ecto/Ecto.html">Ecto</a> database library (schema and migration definitions)</p>
</li>
</ul>
<h2 id="what-is-needle%3F">What is Needle? <a class="direct-link" href="#what-is-needle%3F">#</a></h2>
<p>A means of foreign keying many tables in one field. Designed for highly interlinked data in highly dynamic schemata where tracking all the foreign keys is neither desired nor practical.</p>
<blockquote>
<p>A universal foreign key is actually a hard problem. Many approaches are on offer with a variety of tradeoffs. If plugging into Bonfire's Needle-based core extensions isn't a requirement for you (i.e. you don't need to put things into feeds or use boundaries for access-control) should carefully consider a variety of approaches rather than just blindly adopting the one that fitted our project's needs the best!</p>
</blockquote>
<h2 id="identifying-objects---the-uid-type">Identifying objects - the UID type <a class="direct-link" href="#identifying-objects---the-uid-type">#</a></h2>
<p>All referenceable objects in the system have a unique ID (primary key) whose type is the <code>Needle.UID</code>. <code>UUIDv7</code> and <a href="https://github.com/ulid/spec">ULIDs</a> are a lot like standard <code>UUID</code> in that you can generate unique ones independently of the database. It's also a little different, being made up of two parts:</p>
<ul>
<li>The current timestamp, to millisecond precision.</li>
<li>Strong random padding for uniqueness.</li>
</ul>
<p>This means that it naturally sorts by time to the millisecond (close enough for us), giving us a performance advantage compared to queries ordered by a separate creation datetime field (by contrast, UUIDv4 is randomly distributed).</p>
<p>If you've only worked with integer primary keys before, you are probably used to letting the database dispense an ID for you. With <code>ULID</code> (or <code>UUID</code>), IDs can be known <em>before</em> they are stored, greatly easing the process of storing a graph of data and allowing us to do more of the preparation work outside of a transaction for increased performance.</p>
<p>In PostgreSQL, we actually store <code>UUIDv7</code> and <code>ULID</code>s as <code>UUID</code> columns, thanks to both being the same size (and the lack of specific column types shipping with postgresql). You mostly will not notice this because it's handled for you, but there are a few places it can come up:</p>
<ul>
<li>Ecto debug and error output may show either binary values or UUID-formatted values.</li>
<li>Hand-written SQL may need to convert table IDs to the <code>UUID</code> format before use.</li>
</ul>
<h2 id="it's-just-a-table">It's just a table <a class="direct-link" href="#it's-just-a-table">#</a></h2>
<p>The <code>Needle</code> system is mostly based around a single table represented by the <code>Needle.Pointer</code> schema with the following fields:</p>
<ul>
<li><code>id</code> (UID) - the database-wide unique id for the object, primary key.</li>
<li><code>table_id</code> (UID) - identifies the type of the object, references <code>Needle.Table</code>.</li>
<li><code>deleted_at</code> (timestamp, default: <code>null</code>) - when the object was deleted.</li>
</ul>
<p>Every object that is stored in the system will have a record in this table. It may also have records in other tables (handy for storing more than 3 fields about the object!).</p>
<p>A <code>Table</code> is a record of a table that may be linked to by a pointer. A <code>Pointer</code> is a pointer ID and a table ID.<br>
With these two ingredients, we can construct a means of pointing to any table that has a <code>Table</code> entry.</p>
<p>But don't worry about <code>Needle.Table</code> for now, just know that every object type will have a record there so <code>Needle.Pointer.table_id</code> can reference it.</p>
<h2 id="installation">Installation <a class="direct-link" href="#installation">#</a></h2>
<p>Aside from adding the dependency, you will also need to write add a migration to set up the database before you can start writing your regular migrations:</p>
<pre class="language-elixir"><code class="language-elixir"><span class="token keyword">defmodule</span> <span class="token module class-name">MyApp</span><span class="token punctuation">.</span><span class="token module class-name">Repo</span><span class="token punctuation">.</span><span class="token module class-name">Migrations</span><span class="token punctuation">.</span><span class="token module class-name">InitPointers</span> <span class="token keyword">do</span>
  <span class="token attribute variable">@moduledoc</span> <span class="token boolean">false</span>
  <span class="token keyword">use</span> <span class="token module class-name">Ecto</span><span class="token punctuation">.</span><span class="token module class-name">Migration</span>
  <span class="token keyword">import</span> <span class="token module class-name">Needle</span><span class="token punctuation">.</span><span class="token module class-name">Migration</span>

  <span class="token keyword">def</span> <span class="token function">up</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token attr-name">do:</span> <span class="token function">inits</span><span class="token punctuation">(</span><span class="token atom symbol">:up</span><span class="token punctuation">)</span>
  <span class="token keyword">def</span> <span class="token function">down</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token attr-name">do:</span> <span class="token function">inits</span><span class="token punctuation">(</span><span class="token atom symbol">:down</span><span class="token punctuation">)</span>

  <span class="token keyword">defp</span> <span class="token function">inits</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token function">init_pointers_ulid_extra</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span> <span class="token comment"># this one is optional but recommended</span>
    <span class="token function">init_pointers</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span> <span class="token comment"># this one is not optional</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span></code></pre>
<blockquote>
<p>Note: Pointers is already a default dependency of most Bonfire extensions, so you shouldn't need to add the migration if building a new extension.</p>
</blockquote>
<h2 id="declaring-object-types">Declaring Object Types <a class="direct-link" href="#declaring-object-types">#</a></h2>
<h3 id="picking-a-table-id">Picking a table id <a class="direct-link" href="#picking-a-table-id">#</a></h3>
<p>The first step to declaring a new type is picking a unique table ID in UID format.</p>
<p>You could just generate a random UID, but since these IDs are special, we tend to assign a synthetic UID that are readable as words so they stand out in debug output.</p>
<p>For example, the ID for the <code>Feed</code> table is: <code>1TFEEDS0NTHES0V1S0FM0RTA1S</code>, which can be read as &quot;It feeds on the souls of mortals&quot;. Feel free to have a little fun coming up with them, it makes debug output a little more cheery! The rules are:</p>
<ul>
<li>The alphabet is <a href="https://en.wikipedia.org/wiki/Base32#Crockford's_Base32">Crockford's Base32</a>.</li>
<li>They must be 26 characters in length.</li>
<li>The first character must be a digit in the range 0-7.</li>
</ul>
<p>To help you with this, the <code>Needle.UID.synthesise!/1</code> method takes an alphanumeric binary and tries to return you it transliterated into a valid UID. Example usage:</p>
<pre><code>iex(1)&gt; Needle.UID.synthesise!(&quot;itfeedsonthesouls&quot;)

11:20:28.299 [error] Too short, need 9 chars.
:ok
iex(2)&gt; Needle.UID.synthesise!(&quot;itfeedsonthesoulsofmortalsandothers&quot;)

11:20:31.819 [warn]  Too long, chopping off last 9 chars
&quot;1TFEEDS0NTHES0V1S0FM0RTA1S&quot;
iex(3)&gt; Needle.UID.synthesise!(&quot;itfeedsonthesoulsofmortals&quot;)
&quot;1TFEEDS0NTHES0V1S0FM0RTA1S&quot;
iex(4)&gt; Needle.UID.synthesise!(&quot;gtfeedsonthesoulsofmortals&quot;)

11:21:03.268 [warn]  First character must be a digit in the range 0-7, replacing with 7
&quot;7TFEEDS0NTHES0V1S0FM0RTA1S&quot;
</code></pre>
<h3 id="virtual-pointables-(%22virtuals%22)">Virtual pointables (&quot;virtuals&quot;) <a class="direct-link" href="#virtual-pointables-(%22virtuals%22)">#</a></h3>
<p><code>Needle.Virtual</code> is the simplest and most common type of object. Here's a definition of block:</p>
<pre class="language-elixir"><code class="language-elixir"><span class="token keyword">defmodule</span> <span class="token module class-name">Bonfire</span><span class="token punctuation">.</span><span class="token module class-name">Data</span><span class="token punctuation">.</span><span class="token module class-name">Social</span><span class="token punctuation">.</span><span class="token module class-name">Block</span> <span class="token keyword">do</span>

  <span class="token keyword">use</span> <span class="token module class-name">Needle</span><span class="token punctuation">.</span><span class="token module class-name">Virtual</span><span class="token punctuation">,</span>
    <span class="token attr-name">otp_app:</span> <span class="token atom symbol">:bonfire_data_social</span><span class="token punctuation">,</span>
    <span class="token attr-name">table_id:</span> <span class="token string">"310CK1NGSTVFFAV01DSSEE1NG1"</span><span class="token punctuation">,</span>
    <span class="token attr-name">source:</span> <span class="token string">"bonfire_data_social_block"</span>

  <span class="token keyword">alias</span> <span class="token module class-name">Bonfire</span><span class="token punctuation">.</span><span class="token module class-name">Data</span><span class="token punctuation">.</span><span class="token module class-name">Edges</span><span class="token punctuation">.</span><span class="token module class-name">Edge</span>

  virtual_schema <span class="token keyword">do</span>
    has_one <span class="token atom symbol">:edge</span><span class="token punctuation">,</span> <span class="token module class-name">Edge</span><span class="token punctuation">,</span> <span class="token attr-name">foreign_key:</span> <span class="token atom symbol">:id</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span></code></pre>
<p>It should look quite similar to a mixin definition, except that we <code>use</code> <code>Needle.Virtual</code> this time (passing an additional <code>table_id</code> argument) and we call the <code>virtual_schema</code> macro.</p>
<p>The primary limitation of a virtual is that you cannot put extra fields on it. This also means that <code>belongs_to</code> is not generally permitted because it results in adding a field, while <code>has_one</code> and <code>has_many</code> work just fine as they do not cause the creation of fields in the schema.</p>
<p>This is not usually a problem, as extra fields can be put into <a href="mixins-storing-data-about-objects">mixins</a> or <a href="#multimixins">multimixins</a> as appropriate.</p>
<p>In all other respects, they behave like Pointables. You can have changesets over them and select and insert as usual.</p>
<blockquote>
<p>Under the hood, a virtual has a writable view (in the above example, called <code>bonfire_data_social_block</code>). It looks like a table with just an id, but it's populated with all the ids of blocks that have not been deleted. When the view is inserted into, a record is created in the <code>pointers</code> table for you transparently. When you delete from the view, the corresponding <code>pointers</code> entry is marked deleted for you.</p>
</blockquote>
<blockquote>
<p>Before introducing Virtuals, we noticed it was very common to create Pointables with no extra fields just so we could use the Needle system. Virtuals are alternative for this case that requires less typing and provides a reduced overhead vs pointable (as they save the cost of maintaining a primary key in that table and the associated disk space).</p>
</blockquote>
<h3 id="pointables">Pointables <a class="direct-link" href="#pointables">#</a></h3>
<p>The other, lesser used, type of object is called the <code>Needle.Pointable</code>. The major difference is that unlike the simple case of virtuals, pointables are not backed by views, but by tables.</p>
<blockquote>
<p>When a record is inserted into a pointable table, a copy is made in the <code>pointers</code> table for you transparently. When you delete from the table, the the corresponding <code>pointers</code> entry is marked deleted for you. In these ways, they behave very much like virtuals. By having a table, however, we are free to add new fields.</p>
</blockquote>
<p>Pointables pay for this flexibility by being slightly more expensive than virtuals:</p>
<ul>
<li>Records must be inserted into/deleted from two tables (the pointable's table and the <code>pointers</code> table).</li>
<li>The pointable table needs its own primary key index.</li>
</ul>
<p>The choice of using a pointable instead of a virtual combined with one or more mixins is ultimately up to you.</p>
<p>Here is a definition of a pointable type (indicating an ActivityPub activity whose type we don't recognise, stored as a JSON blob):</p>
<pre class="language-elixir"><code class="language-elixir"><span class="token keyword">defmodule</span> <span class="token module class-name">Bonfire</span><span class="token punctuation">.</span><span class="token module class-name">Data</span><span class="token punctuation">.</span><span class="token module class-name">Social</span><span class="token punctuation">.</span><span class="token module class-name">APActivity</span> <span class="token keyword">do</span>

  <span class="token keyword">use</span> <span class="token module class-name">Needle</span><span class="token punctuation">.</span><span class="token module class-name">Pointable</span><span class="token punctuation">,</span>
    <span class="token attr-name">otp_app:</span> <span class="token atom symbol">:bonfire_data_social</span><span class="token punctuation">,</span>
    <span class="token attr-name">table_id:</span> <span class="token string">"30NF1REAPACTTAB1ENVMBER0NE"</span><span class="token punctuation">,</span>
    <span class="token attr-name">source:</span> <span class="token string">"bonfire_data_social_apactivity"</span>

  pointable_schema <span class="token keyword">do</span>
    field <span class="token atom symbol">:json</span><span class="token punctuation">,</span> <span class="token atom symbol">:map</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span></code></pre>
<blockquote>
<p>As you can see, to declare a pointable schema, we start by using <code>Needle.Pointable</code>, providing the name of our otp application, the source table's name in the database and our chosen sentinel UID.</p>
</blockquote>
<blockquote>
<p>We then call <code>pointable_schema</code> and define any fields we wish to put directly in the table. For the most part, <code>pointable_schema</code> is like Ecto's <code>schema</code> macro, except you do not provide the table name and let it handle the primary key.</p>
</blockquote>
<blockquote>
<p>If for some reason you wished to turn ID autogeneration off, you could pass <code>autogenerate: false</code> to the options provided when using <code>Needle.Pointable</code>.</p>
</blockquote>
<h2 id="adding-re-usable-fields">Adding re-usable fields <a class="direct-link" href="#adding-re-usable-fields">#</a></h2>
<h3 id="mixins---storing-data-about-objects">Mixins - storing data about objects <a class="direct-link" href="#mixins---storing-data-about-objects">#</a></h3>
<p>Mixins are tables which contain extra information on behalf of objects. Each object can choose to<br>
record or not record information for each mixin. Sample mixins include:</p>
<ul>
<li>user profile (containing a name, location and summary)</li>
<li>post content (containing the title, summary, and/or html body of a post or message)</li>
<li>created (containing the id of the object creator)</li>
</ul>
<p>In this way, they are reusable across different object types. One mixin may (or may not) be used by any number of objects. This is mostly driven by the type of the object we are storing, but can also be driven by user input.</p>
<p>Mixins are just tables too! The only requirement is they have a <code>UID</code> primary key which references <code>Needle.Pointer</code>. The developer of the mixin is free to put whatever other fields they want in the table, so long as they have that primary-key-as-reference (which will be automatically added for you by the <code>mixin_schema</code> macro).</p>
<p>Here is a sample mixin definition for a user profile:</p>
<pre class="language-elixir"><code class="language-elixir"><span class="token keyword">defmodule</span> <span class="token module class-name">Bonfire</span><span class="token punctuation">.</span><span class="token module class-name">Data</span><span class="token punctuation">.</span><span class="token module class-name">Social</span><span class="token punctuation">.</span><span class="token module class-name">Profile</span> <span class="token keyword">do</span>

  <span class="token keyword">use</span> <span class="token module class-name">Needle</span><span class="token punctuation">.</span><span class="token module class-name">Mixin</span><span class="token punctuation">,</span>
    <span class="token attr-name">otp_app:</span> <span class="token atom symbol">:bonfire_data_social</span><span class="token punctuation">,</span>
    <span class="token attr-name">source:</span> <span class="token string">"bonfire_data_social_profile"</span>

  mixin_schema <span class="token keyword">do</span>
    field <span class="token atom symbol">:name</span><span class="token punctuation">,</span> <span class="token atom symbol">:string</span>
    field <span class="token atom symbol">:summary</span><span class="token punctuation">,</span> <span class="token atom symbol">:string</span>
    field <span class="token atom symbol">:website</span><span class="token punctuation">,</span> <span class="token atom symbol">:string</span>
    field <span class="token atom symbol">:location</span><span class="token punctuation">,</span> <span class="token atom symbol">:string</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span></code></pre>
<blockquote>
<p>Mixin tables are not themselves pointable, so there is no need to specify a table id as when defining a pointable schema.</p>
</blockquote>
<p>Aside from <code>use</code>ing <code>Needle.Mixin</code> instead of <code>Ecto.Schema</code> and calling <code>mixin_schema</code> instead of<br>
<code>schema</code>, pretty similar to a standard Ecto schema, right?</p>
<p>The arguments to <code>use Needle.Mixin</code> are:</p>
<ul>
<li><code>otp_app</code>: the OTP app name to use when loading dynamic configuration, e.g. the current extension or app (required)</li>
<li><code>source</code>: the underlying table name to use in the database</li>
</ul>
<p>We will cover dynamic configuration later. For now, you can use the OTP app that includes the module.</p>
<h3 id="multimixins">Multimixins <a class="direct-link" href="#multimixins">#</a></h3>
<p>Multimixins are like mixins, except that where an object may have 0 or 1 of a particular mixins, an object may have any number of a particular multimixin.</p>
<p>For this to work, a multimixin must have a <em>compound primary key</em> which must contain an <code>id</code> column referencing <code>Needle.Pointer</code> and at least one other field which will collectively be unique.</p>
<p>An example multimixin is used for publishing an item to feeds:</p>
<pre class="language-elixir"><code class="language-elixir"><span class="token keyword">defmodule</span> <span class="token module class-name">Bonfire</span><span class="token punctuation">.</span><span class="token module class-name">Data</span><span class="token punctuation">.</span><span class="token module class-name">Social</span><span class="token punctuation">.</span><span class="token module class-name">FeedPublish</span> <span class="token keyword">do</span>

  <span class="token keyword">use</span> <span class="token module class-name">Needle</span><span class="token punctuation">.</span><span class="token module class-name">Mixin</span><span class="token punctuation">,</span>
    <span class="token attr-name">otp_app:</span> <span class="token atom symbol">:bonfire_data_social</span><span class="token punctuation">,</span>
    <span class="token attr-name">source:</span> <span class="token string">"bonfire_data_social_feed_publish"</span>

  <span class="token keyword">alias</span> <span class="token module class-name">Needle</span><span class="token punctuation">.</span><span class="token module class-name">Pointer</span>

  mixin_schema <span class="token keyword">do</span>
    belongs_to <span class="token atom symbol">:feed</span><span class="token punctuation">,</span> <span class="token module class-name">Pointer</span><span class="token punctuation">,</span> <span class="token attr-name">primary_key:</span> <span class="token boolean">true</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span></code></pre>
<p>Notice that this looks very similar to defining a mixin. Indeed, the only difference is the <code>primary_key: true</code> in this line, which adds a second field to the compound primary key.<br>
This results in ecto recording a compound primary key of <code>(id, feed_id)</code> for the schema (the id is added for you as with regular mixins).</p>
<h2 id="writing-migrations">Writing Migrations <a class="direct-link" href="#writing-migrations">#</a></h2>
<p>Migrations are typically included along with the schemas as public APIs you can call within your project's migrations.</p>
<h3 id="virtuals">Virtuals <a class="direct-link" href="#virtuals">#</a></h3>
<p>Most virtuals are incredibly simple to migrate for:</p>
<pre class="language-elixir"><code class="language-elixir"><span class="token keyword">defmodule</span> <span class="token module class-name">Bonfire</span><span class="token punctuation">.</span><span class="token module class-name">Data</span><span class="token punctuation">.</span><span class="token module class-name">Social</span><span class="token punctuation">.</span><span class="token module class-name">Post</span><span class="token punctuation">.</span><span class="token module class-name">Migration</span> <span class="token keyword">do</span>

  <span class="token keyword">import</span> <span class="token module class-name">Needle</span><span class="token punctuation">.</span><span class="token module class-name">Migration</span>
  <span class="token keyword">alias</span> <span class="token module class-name">Bonfire</span><span class="token punctuation">.</span><span class="token module class-name">Data</span><span class="token punctuation">.</span><span class="token module class-name">Social</span><span class="token punctuation">.</span><span class="token module class-name">Post</span>

  <span class="token keyword">def</span> <span class="token function">migrate_post</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token attr-name">do:</span> <span class="token function">migrate_virtual</span><span class="token punctuation">(</span><span class="token module class-name">Post</span><span class="token punctuation">)</span>

<span class="token keyword">end</span></code></pre>
<p>If you need to do more work, it can be a little trickier. Here's an example for <code>block</code>, which also creates a unique index on another table:</p>
<pre class="language-elixir"><code class="language-elixir"><span class="token keyword">defmodule</span> <span class="token module class-name">Bonfire</span><span class="token punctuation">.</span><span class="token module class-name">Data</span><span class="token punctuation">.</span><span class="token module class-name">Social</span><span class="token punctuation">.</span><span class="token module class-name">Block</span><span class="token punctuation">.</span><span class="token module class-name">Migration</span> <span class="token keyword">do</span>

  <span class="token keyword">import</span> <span class="token module class-name">Ecto</span><span class="token punctuation">.</span><span class="token module class-name">Migration</span>
  <span class="token keyword">import</span> <span class="token module class-name">Needle</span><span class="token punctuation">.</span><span class="token module class-name">Migration</span>
  <span class="token keyword">import</span> <span class="token module class-name">Bonfire</span><span class="token punctuation">.</span><span class="token module class-name">Data</span><span class="token punctuation">.</span><span class="token module class-name">Edges</span><span class="token punctuation">.</span><span class="token module class-name">Edge</span><span class="token punctuation">.</span><span class="token module class-name">Migration</span>
  <span class="token keyword">alias</span> <span class="token module class-name">Bonfire</span><span class="token punctuation">.</span><span class="token module class-name">Data</span><span class="token punctuation">.</span><span class="token module class-name">Social</span><span class="token punctuation">.</span><span class="token module class-name">Block</span>

  <span class="token keyword">def</span> <span class="token function">migrate_block_view</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token attr-name">do:</span> <span class="token function">migrate_virtual</span><span class="token punctuation">(</span><span class="token module class-name">Block</span><span class="token punctuation">)</span>

  <span class="token keyword">def</span> <span class="token function">migrate_block_unique_index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token attr-name">do:</span> <span class="token function">migrate_type_unique_index</span><span class="token punctuation">(</span><span class="token module class-name">Block</span><span class="token punctuation">)</span>

  <span class="token keyword">def</span> <span class="token function">migrate_block</span><span class="token punctuation">(</span>dir <span class="token operator">\\</span> <span class="token function">direction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token keyword">def</span> <span class="token function">migrate_block</span><span class="token punctuation">(</span><span class="token atom symbol">:up</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token function">migrate_block_view</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">migrate_block_unique_index</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">end</span>

  <span class="token keyword">def</span> <span class="token function">migrate_block</span><span class="token punctuation">(</span><span class="token atom symbol">:down</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token function">migrate_block_unique_index</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">migrate_block_view</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">end</span>

<span class="token keyword">end</span></code></pre>
<p>Notice how we have to write our <code>up</code> and <code>down</code> versions separately to get the correct ordering of operations.</p>
<h3 id="pointables-1">Pointables <a class="direct-link" href="#pointables-1">#</a></h3>
<p>Migration example for a <code>Pointable</code>:</p>
<pre class="language-elixir"><code class="language-elixir"><span class="token keyword">defmodule</span> <span class="token module class-name">Bonfire</span><span class="token punctuation">.</span><span class="token module class-name">Data</span><span class="token punctuation">.</span><span class="token module class-name">Social</span><span class="token punctuation">.</span><span class="token module class-name">APActivity</span><span class="token punctuation">.</span><span class="token module class-name">Migration</span> <span class="token keyword">do</span>
  <span class="token attribute variable">@moduledoc</span> <span class="token boolean">false</span>
  <span class="token keyword">use</span> <span class="token module class-name">Ecto</span><span class="token punctuation">.</span><span class="token module class-name">Migration</span>
  <span class="token keyword">import</span> <span class="token module class-name">Needle</span><span class="token punctuation">.</span><span class="token module class-name">Migration</span>
  <span class="token keyword">alias</span> <span class="token module class-name">Bonfire</span><span class="token punctuation">.</span><span class="token module class-name">Data</span><span class="token punctuation">.</span><span class="token module class-name">Social</span><span class="token punctuation">.</span><span class="token module class-name">APActivity</span>

  <span class="token keyword">defp</span> <span class="token function">make_apactivity_table</span><span class="token punctuation">(</span>exprs<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token keyword">quote</span> <span class="token keyword">do</span>
      <span class="token keyword">require</span> <span class="token module class-name">Needle</span><span class="token punctuation">.</span><span class="token module class-name">Migration</span>
      <span class="token module class-name">Needle</span><span class="token punctuation">.</span><span class="token module class-name">Migration</span><span class="token punctuation">.</span><span class="token function">create_pointable_table</span><span class="token punctuation">(</span><span class="token module class-name">Bonfire</span><span class="token punctuation">.</span><span class="token module class-name">Data</span><span class="token punctuation">.</span><span class="token module class-name">Social</span><span class="token punctuation">.</span><span class="token module class-name">APActivity</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
        <span class="token module class-name">Ecto</span><span class="token punctuation">.</span><span class="token module class-name">Migration</span><span class="token punctuation">.</span>add <span class="token atom symbol">:json</span><span class="token punctuation">,</span> <span class="token atom symbol">:jsonb</span>
        <span class="token function">unquote_splicing</span><span class="token punctuation">(</span>exprs<span class="token punctuation">)</span>
      <span class="token keyword">end</span>
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>

  <span class="token keyword">defmacro</span> create_apactivity_table<span class="token punctuation">,</span> <span class="token attr-name">do:</span> <span class="token function">make_apactivity_table</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">defmacro</span> <span class="token function">create_apactivity_table</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token attr-name">do:</span> body<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token attr-name">do:</span> <span class="token function">make_apactivity_table</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span>

  <span class="token keyword">def</span> <span class="token function">drop_apactivity_table</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token attr-name">do:</span> <span class="token function">drop_pointable_table</span><span class="token punctuation">(</span><span class="token module class-name">APActivity</span><span class="token punctuation">)</span>

  <span class="token keyword">defp</span> <span class="token function">maa</span><span class="token punctuation">(</span><span class="token atom symbol">:up</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token attr-name">do:</span> <span class="token function">make_apactivity_table</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">defp</span> <span class="token function">maa</span><span class="token punctuation">(</span><span class="token atom symbol">:down</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token keyword">quote</span> <span class="token attr-name">do:</span> <span class="token module class-name">Bonfire</span><span class="token punctuation">.</span><span class="token module class-name">Data</span><span class="token punctuation">.</span><span class="token module class-name">Social</span><span class="token punctuation">.</span><span class="token module class-name">APActivity</span><span class="token punctuation">.</span><span class="token module class-name">Migration</span><span class="token punctuation">.</span><span class="token function">drop_apactivity_table</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">end</span>

  <span class="token keyword">defmacro</span> <span class="token function">migrate_apactivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token keyword">quote</span> <span class="token keyword">do</span>
      <span class="token keyword">if</span> <span class="token module class-name">Ecto</span><span class="token punctuation">.</span><span class="token module class-name">Migration</span><span class="token punctuation">.</span><span class="token function">direction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token atom symbol">:up</span><span class="token punctuation">,</span>
        <span class="token attr-name">do:</span> <span class="token function">unquote</span><span class="token punctuation">(</span><span class="token function">maa</span><span class="token punctuation">(</span><span class="token atom symbol">:up</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token attr-name">else:</span> <span class="token function">unquote</span><span class="token punctuation">(</span><span class="token function">maa</span><span class="token punctuation">(</span><span class="token atom symbol">:down</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>

<span class="token keyword">end</span></code></pre>
<p>As you can see, this <code>Pointable</code> migration a little trickier to define than a <code>Virtual</code> because we wanted to preserve the ability for the user to define extra fields in config. There are some questions about how useful this is in practice, so you could also go for a simpler option:</p>
<pre class="language-elixir"><code class="language-elixir"><span class="token keyword">defmodule</span> <span class="token module class-name">MyApp</span><span class="token punctuation">.</span><span class="token module class-name">Repo</span><span class="token punctuation">.</span><span class="token module class-name">Migrations</span><span class="token punctuation">.</span><span class="token module class-name">Greeting</span> <span class="token keyword">do</span>
  <span class="token attribute variable">@moduledoc</span> <span class="token boolean">false</span>
  <span class="token keyword">use</span> <span class="token module class-name">Ecto</span><span class="token punctuation">.</span><span class="token module class-name">Migration</span>
  <span class="token keyword">import</span> <span class="token module class-name">Needle</span><span class="token punctuation">.</span><span class="token module class-name">Migration</span>

  <span class="token keyword">def</span> <span class="token function">up</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token function">create_pointable_table</span><span class="token punctuation">(</span><span class="token atom symbol">:greeting</span><span class="token punctuation">,</span> <span class="token string">"GREET1NGSFR0MD0CEXAMP1E000"</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
      add <span class="token atom symbol">:greeting</span><span class="token punctuation">,</span> <span class="token atom symbol">:text</span><span class="token punctuation">,</span> <span class="token attr-name">null:</span> <span class="token boolean">false</span>
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>

  <span class="token keyword">def</span> <span class="token function">down</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token function">drop_pointable_table</span><span class="token punctuation">(</span><span class="token atom symbol">:greeting</span><span class="token punctuation">,</span> <span class="token string">"GREET1NGSFR0MD0CEXAMP1E000"</span><span class="token punctuation">)</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span></code></pre>
<blockquote>
<p>As you can see, it's pretty similar to defining a regular migration, except you use <code>create_pointable_table</code> and<br>
<code>drop_pointable_table</code>. Notice that our sentinel UID makes an appearance again here. It's <em>very</em> important that these match what we declared in the schema.</p>
</blockquote>
<h3 id="mixins">Mixins <a class="direct-link" href="#mixins">#</a></h3>
<p>Mixins look much like pointables:</p>
<pre class="language-elixir"><code class="language-elixir"><span class="token keyword">defmodule</span> <span class="token module class-name">Bonfire</span><span class="token punctuation">.</span><span class="token module class-name">Data</span><span class="token punctuation">.</span><span class="token module class-name">Social</span><span class="token punctuation">.</span><span class="token module class-name">Profile</span><span class="token punctuation">.</span><span class="token module class-name">Migration</span> <span class="token keyword">do</span>

  <span class="token keyword">import</span> <span class="token module class-name">Needle</span><span class="token punctuation">.</span><span class="token module class-name">Migration</span>
  <span class="token keyword">alias</span> <span class="token module class-name">Bonfire</span><span class="token punctuation">.</span><span class="token module class-name">Data</span><span class="token punctuation">.</span><span class="token module class-name">Social</span><span class="token punctuation">.</span><span class="token module class-name">Profile</span>

  <span class="token comment"># create_profile_table/{0,1}</span>

  <span class="token keyword">defp</span> <span class="token function">make_profile_table</span><span class="token punctuation">(</span>exprs<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token keyword">quote</span> <span class="token keyword">do</span>
      <span class="token keyword">require</span> <span class="token module class-name">Needle</span><span class="token punctuation">.</span><span class="token module class-name">Migration</span>
      <span class="token module class-name">Needle</span><span class="token punctuation">.</span><span class="token module class-name">Migration</span><span class="token punctuation">.</span><span class="token function">create_mixin_table</span><span class="token punctuation">(</span><span class="token module class-name">Bonfire</span><span class="token punctuation">.</span><span class="token module class-name">Data</span><span class="token punctuation">.</span><span class="token module class-name">Social</span><span class="token punctuation">.</span><span class="token module class-name">Profile</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
        <span class="token module class-name">Ecto</span><span class="token punctuation">.</span><span class="token module class-name">Migration</span><span class="token punctuation">.</span>add <span class="token atom symbol">:name</span><span class="token punctuation">,</span> <span class="token atom symbol">:text</span>
        <span class="token module class-name">Ecto</span><span class="token punctuation">.</span><span class="token module class-name">Migration</span><span class="token punctuation">.</span>add <span class="token atom symbol">:summary</span><span class="token punctuation">,</span> <span class="token atom symbol">:text</span>
        <span class="token module class-name">Ecto</span><span class="token punctuation">.</span><span class="token module class-name">Migration</span><span class="token punctuation">.</span>add <span class="token atom symbol">:website</span><span class="token punctuation">,</span> <span class="token atom symbol">:text</span>
        <span class="token module class-name">Ecto</span><span class="token punctuation">.</span><span class="token module class-name">Migration</span><span class="token punctuation">.</span>add <span class="token atom symbol">:location</span><span class="token punctuation">,</span> <span class="token atom symbol">:text</span>
        <span class="token module class-name">Ecto</span><span class="token punctuation">.</span><span class="token module class-name">Migration</span><span class="token punctuation">.</span>add <span class="token atom symbol">:icon_id</span><span class="token punctuation">,</span> <span class="token function">strong_pointer</span><span class="token punctuation">(</span><span class="token module class-name">Bonfire</span><span class="token punctuation">.</span><span class="token module class-name">Files</span><span class="token punctuation">.</span><span class="token module class-name">Media</span><span class="token punctuation">)</span>
        <span class="token module class-name">Ecto</span><span class="token punctuation">.</span><span class="token module class-name">Migration</span><span class="token punctuation">.</span>add <span class="token atom symbol">:image_id</span><span class="token punctuation">,</span> <span class="token function">strong_pointer</span><span class="token punctuation">(</span><span class="token module class-name">Bonfire</span><span class="token punctuation">.</span><span class="token module class-name">Files</span><span class="token punctuation">.</span><span class="token module class-name">Media</span><span class="token punctuation">)</span>
        <span class="token function">unquote_splicing</span><span class="token punctuation">(</span>exprs<span class="token punctuation">)</span>
      <span class="token keyword">end</span>
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>

  <span class="token keyword">defmacro</span> <span class="token function">create_profile_table</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token attr-name">do:</span> <span class="token function">make_profile_table</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">defmacro</span> <span class="token function">create_profile_table</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token attr-name">do:</span> <span class="token punctuation">{</span>_<span class="token punctuation">,</span> _<span class="token punctuation">,</span> body<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token attr-name">do:</span> <span class="token function">make_profile_table</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span>

  <span class="token comment"># drop_profile_table/0</span>

  <span class="token keyword">def</span> <span class="token function">drop_profile_table</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token attr-name">do:</span> <span class="token function">drop_mixin_table</span><span class="token punctuation">(</span><span class="token module class-name">Profile</span><span class="token punctuation">)</span>

  <span class="token comment"># migrate_profile/{0,1}</span>

  <span class="token keyword">defp</span> <span class="token function">mp</span><span class="token punctuation">(</span><span class="token atom symbol">:up</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token attr-name">do:</span> <span class="token function">make_profile_table</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

  <span class="token keyword">defp</span> <span class="token function">mp</span><span class="token punctuation">(</span><span class="token atom symbol">:down</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token keyword">quote</span> <span class="token keyword">do</span>
      <span class="token module class-name">Bonfire</span><span class="token punctuation">.</span><span class="token module class-name">Data</span><span class="token punctuation">.</span><span class="token module class-name">Social</span><span class="token punctuation">.</span><span class="token module class-name">Profile</span><span class="token punctuation">.</span><span class="token module class-name">Migration</span><span class="token punctuation">.</span><span class="token function">drop_profile_table</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>

  <span class="token keyword">defmacro</span> <span class="token function">migrate_profile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token keyword">quote</span> <span class="token keyword">do</span>
      <span class="token keyword">if</span> <span class="token module class-name">Ecto</span><span class="token punctuation">.</span><span class="token module class-name">Migration</span><span class="token punctuation">.</span><span class="token function">direction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token atom symbol">:up</span><span class="token punctuation">,</span>
        <span class="token attr-name">do:</span> <span class="token function">unquote</span><span class="token punctuation">(</span><span class="token function">mp</span><span class="token punctuation">(</span><span class="token atom symbol">:up</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token attr-name">else:</span> <span class="token function">unquote</span><span class="token punctuation">(</span><span class="token function">mp</span><span class="token punctuation">(</span><span class="token atom symbol">:down</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>

<span class="token keyword">end</span></code></pre>
<h3 id="multimixins-1">Multimixins <a class="direct-link" href="#multimixins-1">#</a></h3>
<p>Similar to mixins:</p>
<pre class="language-elixir"><code class="language-elixir"><span class="token keyword">defmodule</span> <span class="token module class-name">Bonfire</span><span class="token punctuation">.</span><span class="token module class-name">Data</span><span class="token punctuation">.</span><span class="token module class-name">Social</span><span class="token punctuation">.</span><span class="token module class-name">FeedPublish</span><span class="token punctuation">.</span><span class="token module class-name">Migration</span> <span class="token keyword">do</span>

  <span class="token keyword">import</span> <span class="token module class-name">Ecto</span><span class="token punctuation">.</span><span class="token module class-name">Migration</span>
  <span class="token keyword">import</span> <span class="token module class-name">Needle</span><span class="token punctuation">.</span><span class="token module class-name">Migration</span>
  <span class="token keyword">alias</span> <span class="token module class-name">Bonfire</span><span class="token punctuation">.</span><span class="token module class-name">Data</span><span class="token punctuation">.</span><span class="token module class-name">Social</span><span class="token punctuation">.</span><span class="token module class-name">FeedPublish</span>

  <span class="token attribute variable">@feed_publish_table</span> <span class="token module class-name">FeedPublish</span><span class="token punctuation">.</span><span class="token function">__schema__</span><span class="token punctuation">(</span><span class="token atom symbol">:source</span><span class="token punctuation">)</span>

  <span class="token comment"># create_feed_publish_table/{0,1}</span>

  <span class="token keyword">defp</span> <span class="token function">make_feed_publish_table</span><span class="token punctuation">(</span>exprs<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token keyword">quote</span> <span class="token keyword">do</span>
      <span class="token keyword">require</span> <span class="token module class-name">Needle</span><span class="token punctuation">.</span><span class="token module class-name">Migration</span>
      <span class="token module class-name">Needle</span><span class="token punctuation">.</span><span class="token module class-name">Migration</span><span class="token punctuation">.</span><span class="token function">create_mixin_table</span><span class="token punctuation">(</span><span class="token module class-name">Bonfire</span><span class="token punctuation">.</span><span class="token module class-name">Data</span><span class="token punctuation">.</span><span class="token module class-name">Social</span><span class="token punctuation">.</span><span class="token module class-name">FeedPublish</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
        <span class="token module class-name">Ecto</span><span class="token punctuation">.</span><span class="token module class-name">Migration</span><span class="token punctuation">.</span>add <span class="token atom symbol">:feed_id</span><span class="token punctuation">,</span>
          <span class="token module class-name">Needle</span><span class="token punctuation">.</span><span class="token module class-name">Migration</span><span class="token punctuation">.</span><span class="token function">strong_pointer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token attr-name">primary_key:</span> <span class="token boolean">true</span>
        <span class="token function">unquote_splicing</span><span class="token punctuation">(</span>exprs<span class="token punctuation">)</span>
      <span class="token keyword">end</span>
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>

  <span class="token keyword">defmacro</span> <span class="token function">create_feed_publish_table</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token attr-name">do:</span> <span class="token function">make_feed_publish_table</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">defmacro</span> <span class="token function">create_feed_publish_table</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token attr-name">do:</span> <span class="token punctuation">{</span>_<span class="token punctuation">,</span> _<span class="token punctuation">,</span> body<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token attr-name">do:</span> <span class="token function">make_feed_publish_table</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span>

  <span class="token keyword">def</span> <span class="token function">drop_feed_publish_table</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token attr-name">do:</span> <span class="token function">drop_pointable_table</span><span class="token punctuation">(</span><span class="token module class-name">FeedPublish</span><span class="token punctuation">)</span>

  <span class="token keyword">def</span> <span class="token function">migrate_feed_publish_feed_index</span><span class="token punctuation">(</span>dir <span class="token operator">\\</span> <span class="token function">direction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> opts <span class="token operator">\\</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">def</span> <span class="token function">migrate_feed_publish_feed_index</span><span class="token punctuation">(</span><span class="token atom symbol">:up</span><span class="token punctuation">,</span> opts<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token attr-name">do:</span> <span class="token function">create_if_not_exists</span><span class="token punctuation">(</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token attribute variable">@feed_publish_table</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token atom symbol">:feed_id</span><span class="token punctuation">]</span><span class="token punctuation">,</span> opts<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">def</span> <span class="token function">migrate_feed_publish_feed_index</span><span class="token punctuation">(</span><span class="token atom symbol">:down</span><span class="token punctuation">,</span> opts<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token attr-name">do:</span> <span class="token function">drop_if_exists</span><span class="token punctuation">(</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token attribute variable">@feed_publish_table</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token atom symbol">:feed_id</span><span class="token punctuation">]</span><span class="token punctuation">,</span> opts<span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token keyword">defp</span> <span class="token function">mf</span><span class="token punctuation">(</span><span class="token atom symbol">:up</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token keyword">quote</span> <span class="token keyword">do</span>
      <span class="token module class-name">Bonfire</span><span class="token punctuation">.</span><span class="token module class-name">Data</span><span class="token punctuation">.</span><span class="token module class-name">Social</span><span class="token punctuation">.</span><span class="token module class-name">FeedPublish</span><span class="token punctuation">.</span><span class="token module class-name">Migration</span><span class="token punctuation">.</span><span class="token function">create_feed_publish_table</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token module class-name">Bonfire</span><span class="token punctuation">.</span><span class="token module class-name">Data</span><span class="token punctuation">.</span><span class="token module class-name">Social</span><span class="token punctuation">.</span><span class="token module class-name">FeedPublish</span><span class="token punctuation">.</span><span class="token module class-name">Migration</span><span class="token punctuation">.</span><span class="token function">migrate_feed_publish_feed_index</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>

  <span class="token keyword">defp</span> <span class="token function">mf</span><span class="token punctuation">(</span><span class="token atom symbol">:down</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token keyword">quote</span> <span class="token keyword">do</span>
      <span class="token module class-name">Bonfire</span><span class="token punctuation">.</span><span class="token module class-name">Data</span><span class="token punctuation">.</span><span class="token module class-name">Social</span><span class="token punctuation">.</span><span class="token module class-name">FeedPublish</span><span class="token punctuation">.</span><span class="token module class-name">Migration</span><span class="token punctuation">.</span><span class="token function">migrate_feed_publish_feed_index</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token module class-name">Bonfire</span><span class="token punctuation">.</span><span class="token module class-name">Data</span><span class="token punctuation">.</span><span class="token module class-name">Social</span><span class="token punctuation">.</span><span class="token module class-name">FeedPublish</span><span class="token punctuation">.</span><span class="token module class-name">Migration</span><span class="token punctuation">.</span><span class="token function">drop_feed_publish_table</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>

  <span class="token keyword">defmacro</span> <span class="token function">migrate_feed_publish</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token keyword">quote</span> <span class="token keyword">do</span>
      <span class="token keyword">if</span> <span class="token module class-name">Ecto</span><span class="token punctuation">.</span><span class="token module class-name">Migration</span><span class="token punctuation">.</span><span class="token function">direction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token atom symbol">:up</span><span class="token punctuation">,</span>
        <span class="token attr-name">do:</span> <span class="token function">unquote</span><span class="token punctuation">(</span><span class="token function">mf</span><span class="token punctuation">(</span><span class="token atom symbol">:up</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token attr-name">else:</span> <span class="token function">unquote</span><span class="token punctuation">(</span><span class="token function">mf</span><span class="token punctuation">(</span><span class="token atom symbol">:down</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>

  <span class="token keyword">defmacro</span> <span class="token function">migrate_feed_publish</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token attr-name">do:</span> <span class="token function">mf</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span>

<span class="token keyword">end</span></code></pre>
<h3 id="more-examples">More examples <a class="direct-link" href="#more-examples">#</a></h3>
<p>Take a look at a few of the migrations in our data libraries. Between them, they cover most<br>
scenarios by now:</p>
<ul>
<li><a href="https://github.com/bonfire-networks/bonfire_data_social/">bonfire_data_social</a></li>
<li><a href="https://github.com/bonfire-networks/bonfire_data_access_control/">bonfire_data_access_control</a></li>
<li><a href="https://github.com/bonfire-networks/bonfire_data_identity/">bonfire_data_identity</a></li>
<li><a href="https://github.com/bonfire-networks/bonfire_data_edges/">bonfire_data_edges</a> (feat. bonus triggers)</li>
</ul>
<p>If you want to know exactly what's happening, you may want to read the code for<br>
<a href="https://github.com/bonfire-networks/needle/blob/main/lib/migration.ex">Needle.Migration</a>.</p>
<h2 id="configuration-and-overrides">Configuration and overrides <a class="direct-link" href="#configuration-and-overrides">#</a></h2>
<p>Every pointable or mixin schema is overrideable with configuration<br>
during compilation (this is why using them requires an <code>:otp_app</code> to<br>
be specified). For example, we could override <code>Needle.Table</code> (which<br>
is a pointable table) thus:</p>
<pre class="language-elixir"><code class="language-elixir">config <span class="token atom symbol">:needle</span><span class="token punctuation">,</span> <span class="token module class-name">Needle</span><span class="token punctuation">.</span><span class="token module class-name">Table</span><span class="token punctuation">,</span> <span class="token attr-name">source:</span> <span class="token string">"my_pointers_table"</span></code></pre>
<p>The <code>table_id</code> is also configurable, but we don't recommend you change it.</p>
<p>In addition, all pointable and mixin schemas permit extension with <a href="https://github.com/bonfire-networks/exto">Exto</a>. See the <code>Exto</code>'s docs for more information about how to extend schemas via configuration. You will probably at the very least want to insert some <code>has_one</code> for mixins off your pointables.</p>
<h2 id="referencing-pointables">Referencing Pointables <a class="direct-link" href="#referencing-pointables">#</a></h2>
<p>Ecto does not know anything about our scheme, so unless we specifically want something to reference one of the pointed tables, we typically <code>belongs_to</code> with <code>Needle.Pointer</code>. The table in which we do this does not itself need to necessarily be a <code>Pointable</code>.</p>
<pre class="language-elixir"><code class="language-elixir"><span class="token keyword">defmodule</span> <span class="token module class-name">MyApp</span><span class="token punctuation">.</span><span class="token module class-name">Foo</span> <span class="token keyword">do</span>

  <span class="token keyword">use</span> <span class="token module class-name">Ecto</span><span class="token punctuation">.</span><span class="token module class-name">Schema</span>

  <span class="token comment"># regular ecto table, not pointable!</span>
  schema <span class="token string">"hello"</span> <span class="token keyword">do</span>
    belongs_to <span class="token atom symbol">:pointer</span><span class="token punctuation">,</span> <span class="token module class-name">Needle</span><span class="token punctuation">.</span><span class="token module class-name">Pointer</span> <span class="token comment"># who knows what it points to?</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span></code></pre>
<p>You may choose to reference a specific schema rather than Pointer if it<br>
will only point to a single table. If you do this, you must ensure<br>
that the referenced record exists in that table in the normal<br>
way. There may be some performance benefit, we didn't benchmark it.</p>
<p>The migration is slightly more complex, we have to decide what type of<br>
a pointer it is. Needle come in three categories:</p>
<ul>
<li>A strong pointer is not nullable and is deleted when the object it<br>
points to is deleted.</li>
<li>A weak pointer is nullable and is nilified when the object it points<br>
to is deleted.</li>
<li>An unbreakable pointer will raise when you attempt to delete the<br>
object it points to.</li>
</ul>
<table>
<thead>
<tr>
<th>Type</th>
<th>Nullable?</th>
<th>On Delete</th>
</tr>
</thead>
<tbody>
<tr>
<td>Strong</td>
<td>No</td>
<td>Cascade</td>
</tr>
<tr>
<td>Weak</td>
<td>Yes</td>
<td>Set Null</td>
</tr>
<tr>
<td>Unbreakable</td>
<td>No</td>
<td>Raise</td>
</tr>
</tbody>
</table>
<p>In this case we will use a strong pointer, because we want it to be<br>
deleted if the pointed object is deleted.</p>
<pre class="language-elixir"><code class="language-elixir"><span class="token keyword">defmodule</span> <span class="token module class-name">MyApp</span><span class="token punctuation">.</span><span class="token module class-name">Repo</span><span class="token punctuation">.</span><span class="token module class-name">Migrations</span><span class="token punctuation">.</span><span class="token module class-name">Hello</span> <span class="token keyword">do</span>
  <span class="token attribute variable">@moduledoc</span> <span class="token boolean">false</span>
  <span class="token keyword">use</span> <span class="token module class-name">Ecto</span><span class="token punctuation">.</span><span class="token module class-name">Migration</span>
  <span class="token keyword">import</span> <span class="token module class-name">Needle</span><span class="token punctuation">.</span><span class="token module class-name">Migration</span>

  <span class="token keyword">def</span> <span class="token function">change</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
    create_if_not_exists <span class="token function">table</span><span class="token punctuation">(</span><span class="token atom symbol">:hello</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
      add <span class="token atom symbol">:pointer</span><span class="token punctuation">,</span> <span class="token function">strong_pointer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token attr-name">null:</span> <span class="token boolean">false</span>
      add <span class="token atom symbol">:greeting</span><span class="token punctuation">,</span> <span class="token atom symbol">:text</span><span class="token punctuation">,</span> <span class="token attr-name">null:</span> <span class="token boolean">false</span>
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span></code></pre>
<p>If you are pointing to a specific table instead of pointer,<br>
<code>strong_pointer/1</code> allows you to pass the name of that module<br>
(<code>strong_pointer/0</code> calls this with <code>Needle.Pointer</code>).</p>
<h2 id="dereferencing-pointables">Dereferencing Pointables <a class="direct-link" href="#dereferencing-pointables">#</a></h2>
<p>It is common that even though you have a universal foreign key, you<br>
will want to issue different queries based upon the type that is being<br>
pointed to. For this reason, it is up to you to decide how to perform<br>
an onward query.</p>
<p><code>Needle.Pointers.schema/1</code> turns a <code>Pointer</code> into an Ecto schema module name<br>
you can switch against. <code>Needle.Pointers.plan</code> breaks down a list of Needle<br>
into a map of ids keyed by schema module. It is handy to define some<br>
functions in your (non-library) application that can load any type of<br>
pointer in given contexts.</p>
<h2 id="inserting-data">Inserting data <a class="direct-link" href="#inserting-data">#</a></h2>
<h3 id="elixir-based-logic">Elixir-based logic <a class="direct-link" href="#elixir-based-logic">#</a></h3>
<p>The practical result of needle is that it pushes a certain amount of<br>
validation and consistency logic back into elixir land. It is<br>
therefore your elixir code's responsibility to ensure that data is<br>
inserted into the appropriate mixin tables when inserting a pointable<br>
object and to manage deletions as appropriate.</p>
<p>When assembling queries with mixin tables, pay careful attention to<br>
the type of join you are performing. An inner join is explicitly<br>
asking not to be shown objects that do not have a record for that<br>
mixin. You quite possibly wanted to left join.</p>
<h2 id="querying-needle">Querying Needle <a class="direct-link" href="#querying-needle">#</a></h2>
<p>Since <code>Pointer</code> has a table, you can use its <code>table_id</code> field to<br>
filter by pointed type. <code>Needle.Tables.id!/1</code> (or <code>ids!/1</code> for a<br>
list) can be used to obtain the IDs for a table or tables.</p>
<h2 id="tradeoffs">Tradeoffs <a class="direct-link" href="#tradeoffs">#</a></h2>
<p>All solutions to the universal primary key problem have tradeofs. Here<br>
are what we see as the deficiencies in our approach:</p>
<ol>
<li>It forces a UUIDv7 or ULID on you. This is great for us, but not<br>
everyone. They both expose a timestamp with millisecond precision.<br>
If the time of creation of a resource is sensitive information for<br>
your purposes, they may not going to be suitable for you.</li>
<li>Ecto has no knowledge of the specialty of <code>Pointer</code>,<br>
e.g. <code>Repo.preload</code> does not work and you need to specify a join<br>
condition to join through a pointer. Use our functions or add extra<br>
associations with exto configuration.</li>
<li>Dereferencing a list of needle requires a select query per table<br>
type that occurs in the input set.</li>
<li>Reliance on user attention. You have to follow the instructions<br>
correctly to make the system work at all.</li>
<li>There is likely some performance impact from postgres not<br>
understanding the relationships between the various tables<br>
properly. It's hard to gauge and we haven't even tried.</li>
</ol>
<p>These are not likely to change. If you're going to pick<br>
this library, do so in the full knowledge of the tradeoffs it makes.</p>
<p>Alternatives include (I'm sure you can think of others):</p>
<ul>
<li>Storing the table name in a second column alongside every foreign key.</li>
<li>A compound datatype of id and table name.</li>
<li>Byte/String manipulation tricks.</li>
<li>Evil SQL hacks based upon compile time configuration.</li>
</ul>
<p>While we have our gripes with this approach, once you've gotten the<br>
hang of using it, it works out pretty well for most purposes and it's<br>
one of the simpler options to work with.</p>
<h2 id="copyright-and-license">Copyright and License <a class="direct-link" href="#copyright-and-license">#</a></h2>
<p>Copyright (c) 2020 needle Contributors</p>
<p>Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);<br>
you may not use this file except in compliance with the License.<br>
You may obtain a copy of the License at</p>
<p><a href="http://www.apache.org/licenses/LICENSE-2.0">http://www.apache.org/licenses/LICENSE-2.0</a></p>
<p>Unless required by applicable law or agreed to in writing, software<br>
distributed under the License is distributed on an &quot;AS IS&quot; BASIS,<br>
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.<br>
See the License for the specific language governing permissions and<br>
limitations under the License.</p>

    </div>
  </div>
  <div class="lg:col-span-4 col-span-12 gap-4 flex flex-col">
      <div class="flex items-center space-x-3">
        <a href="https://github.com/bonfire-networks/needle" target="_blank" class="flex-1 w-full btn btn-sm  btn-primary rounded-full">
          Get Code
        </a>
        <a target="_blank" href="https://github.com/bonfire-networks/bonfire-app/issues/new/choose" class="btn rounded-full flex-1 w-full btn-outline border-base-content/30  btn-sm">
            Report bugs
        </a>
    </div>

    

    <div class="bg-base-content/5 mt-4 rounded-lg p-3">
      <div class="uppercase text-xs tracking-widest mb-6">Details</div>
        <div class="gap-2 flex flex-col divide divide-y divide-base-content/30">
          
          <div class="pt-2 flex justify-between items-center text-sm"><span class="font-light">Updated</span> <span class="font-bold">07 Oct 2024</span></div>
          <div class="pt-2 flex justify-between items-center text-sm"><span class="font-light">License</span> <span class="font-bold">apache-2.0</span></div>
            
          
        </div>
    </div>
    
  </div>
</div>
















  <div class="border-base-content/10 bg-base-300 border-t">
 

  <div class="flex px-8 py-4 mx-auto justify-between items-center">
    <div class="flex items-start gap-4 flex-row lg:flex-col">
      <div class="flex items-center gap-2 flex-1 ">
        <span class="block bg-center bg-no-repeat bg-cover" style="width: 30px; height: 40px; background-image: url(/img/bonfire.png)"></span>
        <p class="font-bold">Bonfire Networks</p>
      </div> 
    </div> 
    <a class="github-button" href="https://github.com/bonfire-networks/bonfire-app" data-color-scheme="no-preference: dark_dimmed; light: light; dark: dark;" data-icon="octicon-star" data-size="large" data-show-count="true" aria-label="Star bonfire-networks/bonfire-app on GitHub">Star</a>
  </div>
  <footer class="px-8  justify-between border-t border-base-content/10 px-4 lg:mx-auto  py-8  footer text-base-content">
  <div>
    <span class="font-semibold !capitalize !text-base-content">Ecosystem</span> 
    <a href="/docs" class="link link-hover text-base-content/70">Apps</a> 
    <a href="/roadmap" class="link link-hover text-base-content/70">Extensions</a> 
    <a href="/themes" target="_blank" class="link link-hover text-base-content/70">Themes</a>
  </div> 
  <div>
    <span class="font-semibold !capitalize !text-base-content">Learn</span> 
    <a href="/docs" class="link link-hover text-base-content/70">Documentation</a> 
    <a href="/tutorials" class="link link-hover text-base-content/70">Tutorials</a> 
    <a href="/docs/faq" class="link link-hover text-base-content/70">FAQs</a> 
  </div> 
  <div>
    <span class="font-semibold !capitalize !text-base-content">Apps</span> 
    <a href="/start" class="link link-hover text-base-content/70">Get started</a> 
    <a href="/hosting" class="link link-hover text-base-content/70">Hosting</a> 
    <a href="https://campground.bonfire.cafe" target="_blank" class="link link-hover text-base-content/70">Demo instance</a> 
  </div> 
  <div>
    <span class="font-semibold !capitalize !text-base-content">More</span> 
    <a href="/community" class="link link-hover text-base-content/70">Participate</a> 
    <a href="/conduct" class="link link-hover text-base-content/70">Code of conduct</a> 
    
    <a class="link link-hover text-base-content/70" href="/contact/">Contact</a>

  </div>
</footer>
<div class="flex px-8  mx-auto  flex-col sm:flex-row items-center justify-center sm:justify-between py-[4vmin]">
  <div class="flex items-center">
    <a class="mr-12" href="https://opencollective.com/bonfire-networks"><img src="/img/oc.svg" alt="Open Collective account" width="34" height="34" loading="lazy"></a>
    <a class="mr-12" href="https://github.com/bonfire-networks" target="_blank" rel="noopener noreferrer"><img src="/img/opensource.svg" alt="Open Source" width="89" height="34" loading="lazy"></a>
  </div>
    <nav class="hidden md:flex items-center text-sm">
      
      
      <a class="inline-block pl-2 hover:text-white" href="/">Bonfire Networks 2024</a>
    </nav>
  </div>
</div>
    <!-- Current page: /extension/needle/ -->
  </body>
</html>